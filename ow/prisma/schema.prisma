generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deals        Deal[]   @relation("DealOwner")
  campaigns    Campaign[] @relation("CampaignOwner")
}

model Pipeline {
  id        String  @id @default(cuid())
  name      String  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stages    Stage[]
  deals     Deal[]
}

model Stage {
  id         String   @id @default(cuid())
  name       String
  orderIndex Int
  pipelineId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  deals    Deal[]

  @@unique([pipelineId, name])
  @@unique([pipelineId, orderIndex])
}

model Organization {
  id           String   @id @default(cuid())
  name         String   @unique
  address      String?  // Legacy full address
  websiteUrl   String?
  domain       String?
  linkedInProfile String?
  industry     String?
  annualRevenue String?
  numberOfEmployees String?
  doors        String?
  labels       String?
  profilePicture String?
  
  // Detailed address fields
  streetAddress String?  // Street/road name
  houseNumber  String?   // House number
  apartmentSuite String? // Apartment/suite no
  district     String?   // District/sublocality
  city         String?   // City/town/village/locality
  state        String?   // State/county
  region       String?   // Region
  country      String?   // Country
  zipCode      String?   // ZIP/Postal code
  fullAddress  String?   // Full/combined address
  latitude     String?
  longitude    String?
  
  // Activity tracking from Pipedrive
  openDeals      Int?
  wonDeals       Int?
  lostDeals      Int?
  closedDeals    Int?
  totalActivities Int?
  doneActivities Int?
  activitiesToDo Int?
  emailMessagesCount Int?
  nextActivityDate DateTime?
  lastActivityDate DateTime?
  
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  people Person[]
  deals  Deal[]
  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
  gmailMessages GmailMessage[]
  calendarEvents CalendarEvent[]
  driveFiles DriveFile[]
  noteRecords Note[]
  activities Activity[]
  auditRequests AuditRequest[]
  bookRequests BookRequest[]
  conferenceAttendees ConferenceAttendee[]
}

model Person {
  id             String   @id @default(cuid())
  name           String?  // Full name for easy display
  firstName      String
  lastName       String
  email          String?  @unique
  phone          String?  // Keep for backward compat
  phoneWork      String?
  phoneHome      String?
  phoneMobile    String?
  phoneOther     String?
  emailWork      String?
  emailHome      String?
  emailOther     String?
  title          String?  // Job title
  labels         String?
  contactType    String?
  organizationId String?
  
  // Address fields
  postalAddress  String?  // Full combined address
  streetAddress  String?  // Street/road name
  houseNumber    String?  // House number
  apartmentSuite String?  // Apartment/suite no
  city           String?  // City/town/village/locality
  state          String?  // State/county
  region         String?  // Region
  country        String?  // Country
  zipCode        String?  // ZIP/Postal code
  latitude       String?
  longitude      String?
  
  // Personal info
  birthday       DateTime?
  notes          String?
  linkedInProfile String?
  qwilrProposal  String?
  classification String?
  instantMessenger String?
  marketingStatus String?
  doubleOptIn    String?
  profilePicture String?
  
  // Activity tracking from Pipedrive
  openDeals      Int?
  wonDeals       Int?
  lostDeals      Int?
  closedDeals    Int?
  totalActivities Int?
  doneActivities Int?
  activitiesToDo Int?
  emailMessagesCount Int?
  nextActivityDate DateTime?
  lastActivityDate DateTime?
  lastEmailReceived DateTime?
  lastEmailSent  DateTime?
  
  customFields   Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  deals        Deal[]
  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
  gmailMessages GmailMessage[]
  calendarEvents CalendarEvent[]
  driveFiles DriveFile[]
  noteRecords Note[]
  activities Activity[]
  campaignLeads CampaignLead[]
  auditRequests AuditRequest[]
  bookRequests BookRequest[]
  conferenceAttendees ConferenceAttendee[]
  chatbotConversations ChatbotConversation[]
}

enum DealStatus {
  open
  won
  lost
  deleted
}

model Deal {
  id                String      @id @default(cuid())
  title             String
  value             Decimal     @default(0)
  currency          String      @default("USD")
  status            DealStatus  @default(open)
  probability       Int?
  expectedCloseDate DateTime?
  wonTime           DateTime?
  lostTime          DateTime?
  lostReason        String?
  label             String?
  labels            String?
  
  // Activity tracking
  nextActivityDate  DateTime?
  lastActivityDate  DateTime?
  totalActivities   Int?
  doneActivities    Int?
  activitiesToDo    Int?
  
  // Email tracking
  lastEmailReceived DateTime?
  lastEmailSent     DateTime?
  emailMessagesCount Int?
  
  // Products
  productQuantity   String?
  productAmount     Decimal?
  productName       String?
  mrr               Decimal?
  mrrCurrency       String?
  arr               Decimal?
  arrCurrency       String?
  acv               Decimal?
  acvCurrency       String?
  
  // Source tracking
  sourceOrigin      String?
  sourceOriginId    String?
  sourceChannel     String?
  sourceChannelId   String?
  
  // Custom Opticwise fields
  goLiveTarget      String?
  propertyAddress   String?
  propertyType      String?
  qty               String?  // units, beds, sqft
  arrForecast       Decimal?
  arrForecastCurrency String?
  capexRom          Decimal?
  capexRomCurrency  String?
  roiNoiBomSheet    String?
  printsPlansExternal String?
  printsPlansDropbox String?
  leadSource        String?
  technicalPOC      String?
  icpSegment        String?
  leadSourcePPP     String?
  readinessScore    String?
  ddiAuditStatus    String?
  auditValue        Decimal?
  auditValueCurrency String?
  arrExpansionPotential Decimal?
  arrExpansionCurrency String?
  
  addTime           DateTime    @default(now())
  updateTime        DateTime    @updatedAt
  stageChangeTime   DateTime    @default(now()) // When deal entered current stage
  position          Int         @default(0) // ordering within a stage
  customFields      Json?       // For any additional dynamic fields

  pipelineId     String
  stageId        String
  organizationId String?
  personId       String?
  ownerId        String

  pipeline     Pipeline     @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stage        Stage        @relation(fields: [stageId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  owner        User          @relation("DealOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
  gmailMessages GmailMessage[]
  calendarEvents CalendarEvent[]
  driveFiles DriveFile[]
  noteRecords Note[]
  activities Activity[]
  campaignLeadsConverted CampaignLead[]
  auditRequestsConverted AuditRequest[]
  bookRequestsConverted BookRequest[]
  conferenceAttendeesConverted ConferenceAttendee[]
  chatbotConversationsConverted ChatbotConversation[]

  @@index([pipelineId, stageId])
  @@index([ownerId])
  @@index([organizationId])
  @@index([personId])
}

enum EmailDirection {
  INCOMING
  OUTGOING
}

model EmailThread {
  id             String         @id @default(cuid())
  subject        String
  dealId         String?
  personId       String?
  organizationId String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  messages     EmailMessage[]
}

model EmailMessage {
  id        String         @id @default(cuid())
  threadId  String
  sender    String
  recipients String
  cc        String?
  bcc       String?
  body      String
  direction EmailDirection
  sentAt    DateTime
  createdAt DateTime       @default(now())

  thread EmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

// Fathom.ai Call Transcripts
model CallTranscript {
  id                String   @id @default(cuid())
  fathomCallId      String   @unique  // External ID from Fathom
  title             String
  transcript        String   @db.Text  // Full transcript text
  transcriptJson    Json?    // Structured transcript with speakers and timestamps
  summary           String?  @db.Text  // AI-generated summary if provided by Fathom
  
  // Call metadata
  startTime         DateTime
  endTime           DateTime?
  duration          Int?     // Duration in seconds
  recordingUrl      String?
  
  // Participants (stored as JSON array)
  participants      Json?    // [{name: string, email?: string}]
  
  // Linking to CRM entities
  dealId            String?
  personId          String?
  organizationId    String?
  
  // Metadata
  metadata          Json?    // Raw data from Fathom
  vectorized        Boolean  @default(false) // Flag for AI vectorization status
  vectorEmbedding   String?  @db.Text // Embedding for semantic search (if using)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([fathomCallId])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([startTime])
}

// Google Workspace Integration Models

model GmailMessage {
  id              String   @id @default(cuid())
  gmailMessageId  String   @unique  // Google's message ID
  threadId        String
  subject         String?
  snippet         String?  // Short preview
  body            String?  @db.Text  // Full email body
  bodyHtml        String?  @db.Text  // HTML version
  
  // Participants
  from            String
  to              String?  @db.Text  // Can be multiple, comma-separated
  cc              String?  @db.Text
  bcc             String?  @db.Text
  
  // Metadata
  date            DateTime
  labels          String?  // JSON array of labels
  attachments     Json?    // Array of attachment metadata
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text  // JSON array of embedding vector
  
  // Linking to CRM
  dealId          String?
  personId        String?
  organizationId  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([gmailMessageId])
  @@index([threadId])
  @@index([date])
  @@index([from])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([vectorized])
}

model CalendarEvent {
  id              String   @id @default(cuid())
  googleEventId   String   @unique  // Google's event ID
  summary         String
  description     String?  @db.Text
  location        String?
  
  // Time
  startTime       DateTime
  endTime         DateTime
  timezone        String?
  allDay          Boolean  @default(false)
  
  // Participants
  organizer       String?
  attendees       Json?    // Array of {email, name, responseStatus}
  
  // Meeting details
  meetingLink     String?  // Google Meet or other video link
  conferenceData  Json?    // Full conference details
  
  // Status
  status          String?  // confirmed, tentative, cancelled
  visibility      String?  // default, public, private
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text
  
  // Linking to CRM
  dealId          String?
  personId        String?
  organizationId  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([googleEventId])
  @@index([startTime])
  @@index([organizer])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([vectorized])
}

model DriveFile {
  id              String   @id @default(cuid())
  googleFileId    String   @unique  // Google's file ID
  name            String
  mimeType        String
  description     String?  @db.Text
  
  // File metadata
  size            BigInt?
  webViewLink     String?
  thumbnailLink   String?
  iconLink        String?
  
  // Content for search
  content         String?  @db.Text  // Extracted text content for documents
  
  // Timestamps
  createdTime     DateTime?
  modifiedTime    DateTime?
  viewedTime      DateTime?
  
  // Ownership
  ownedByMe       Boolean  @default(false)
  owners          Json?    // Array of owner info
  sharedWith      Json?    // Array of people with access
  
  // Organization
  parents         Json?    // Array of parent folder IDs
  folderPath      String?  // Computed folder path
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text
  
  // Linking to CRM
  dealId          String?
  personId        String?
  organizationId  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([googleFileId])
  @@index([mimeType])
  @@index([createdTime])
  @@index([modifiedTime])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([vectorized])
}

// Notes - Manual notes added to deals, people, organizations
model Note {
  id              String   @id @default(cuid())
  content         String   @db.Text
  
  // Linking to CRM entities
  dealId          String?
  personId        String?
  organizationId  String?
  
  // Author tracking
  createdBy       String?  // User email or name
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([createdAt])
}

// Activities - To-dos and tasks
enum ActivityType {
  call
  meeting
  task
  deadline
  email
  lunch
}

enum ActivityStatus {
  pending
  done
  cancelled
}

model Activity {
  id              String         @id @default(cuid())
  subject         String
  note            String?        @db.Text
  type            ActivityType   @default(task)
  status          ActivityStatus @default(pending)
  
  // Scheduling
  dueDate         DateTime?
  dueTime         String?        // Time in HH:MM format
  duration        Int?           // Duration in minutes
  
  // Linking to CRM entities
  dealId          String?
  personId        String?
  organizationId  String?
  
  // Assignment
  assignedTo      String?        // User email or name
  createdBy       String?        // User email or name
  
  // Completion tracking
  doneTime        DateTime?
  markedAsDoneBy  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
}

// Website Pages - Scraped and vectorized web pages from sitemap
model WebPage {
  id              String   @id @default(cuid())
  url             String   @unique  // Full URL of the page
  slug            String?           // Path/slug portion of URL
  title           String?           // Page title from <title> tag
  metaDescription String?  @db.Text  // Meta description
  
  // Content
  content         String?  @db.Text  // Extracted text content from page
  headings        Json?              // Array of headings [{level, text}]
  
  // Metadata
  lastModified    DateTime?          // From sitemap lastmod
  changeFreq      String?            // From sitemap changefreq
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text  // JSON array of embedding vector
  
  // Scraping metadata
  scrapedAt       DateTime?
  scrapeStatus    String?  @default("pending")  // pending, success, failed
  scrapeError     String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([url])
  @@index([vectorized])
  @@index([scrapeStatus])
  @@index([scrapedAt])
}

// ============================================
// MARKETING AUTOMATION PLATFORM
// ============================================

// Marketing Campaigns - Main campaign container
model Campaign {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  type        String   // email, multi-channel, conference, book-distribution
  status      String   @default("draft") // draft, active, paused, completed, archived
  
  // Workflow definition (JSON for visual workflow builder)
  workflow    Json?    // Stores node/edge configuration
  
  // Scheduling
  startDate   DateTime?
  endDate     DateTime?
  
  // Goals and metrics
  goalType    String?  // demo_booked, audit_requested, deal_created, meeting_scheduled
  goalTarget  Int?     // Target number of conversions
  
  // Owner
  ownerId     String?
  owner       User?    @relation("CampaignOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  
  // Metadata
  tags        String?  // Comma-separated tags
  metadata    Json?    // Additional campaign data
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  leads       CampaignLead[]
  sequences   CampaignSequence[]
  analytics   CampaignAnalytics[]
  
  @@index([status])
  @@index([ownerId])
  @@index([type])
  @@index([startDate])
}

// Campaign Leads - People enrolled in campaigns
model CampaignLead {
  id              String   @id @default(cuid())
  campaignId      String
  
  // Link to CRM contact (if exists)
  personId        String?
  person          Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  // Or standalone lead data
  email           String
  firstName       String?
  lastName        String?
  company         String?
  title           String?
  phone           String?
  
  // Campaign status
  status          String   @default("new") // new, contacted, engaged, qualified, converted, unsubscribed, bounced
  leadScore       Int      @default(0) // 0-100 lead score
  
  // Workflow tracking
  currentNodeId   String?  // Current position in workflow
  completedNodes  Json?    // Array of completed node IDs
  
  // Engagement tracking
  emailsSent      Int      @default(0)
  emailsOpened    Int      @default(0)
  emailsClicked   Int      @default(0)
  emailsReplied   Int      @default(0)
  lastEngagement  DateTime?
  
  // Conversion tracking
  convertedAt     DateTime?
  convertedToDealId String?
  convertedToDeal Deal?    @relation(fields: [convertedToDealId], references: [id], onDelete: SetNull)
  
  // Metadata
  source          String?  // conference, website, book-download, manual-import
  sourceMetadata  Json?    // Additional source data
  customFields    Json?    // Custom lead fields
  
  // Unsubscribe
  unsubscribedAt  DateTime?
  unsubscribeReason String?
  
  enrolledAt      DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  touchpoints     CampaignTouchpoint[]
  
  @@index([campaignId])
  @@index([personId])
  @@index([email])
  @@index([status])
  @@index([leadScore])
  @@index([convertedToDealId])
}

// Campaign Touchpoints - Individual interactions
model CampaignTouchpoint {
  id              String   @id @default(cuid())
  leadId          String
  campaignId      String?  // Denormalized for easier queries
  
  // Touchpoint details
  type            String   // email, voicemail, linkedin, sms, audit-tool, chatbot
  subject         String?
  content         String?  @db.Text
  
  // Delivery tracking
  sentAt          DateTime @default(now())
  deliveredAt     DateTime?
  bouncedAt       DateTime?
  bounceReason    String?
  
  // Engagement tracking
  opened          Boolean  @default(false)
  openedAt        DateTime?
  clicked         Boolean  @default(false)
  clickedAt       DateTime?
  replied         Boolean  @default(false)
  repliedAt       DateTime?
  
  // Links clicked
  linksClicked    Json?    // Array of clicked URLs
  
  // Metadata
  metadata        Json?    // Provider-specific data (email ID, SMS ID, etc.)
  
  lead            CampaignLead @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  @@index([leadId])
  @@index([campaignId])
  @@index([type])
  @@index([sentAt])
}

// Campaign Sequences - Reusable email/message sequences
model CampaignSequence {
  id              String   @id @default(cuid())
  campaignId      String?
  
  name            String
  description     String?  @db.Text
  type            String   // email, sms, linkedin, multi-channel
  
  // Sequence steps (JSON array)
  steps           Json     // [{delay: 0, type: 'email', subject: '...', content: '...'}]
  
  // Status
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  campaign        Campaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  @@index([campaignId])
  @@index([type])
}

// Campaign Analytics - Daily aggregated metrics
model CampaignAnalytics {
  id              String   @id @default(cuid())
  campaignId      String
  date            DateTime @db.Date
  
  // Volume metrics
  leadsAdded      Int      @default(0)
  leadsActive     Int      @default(0)
  
  // Email metrics
  emailsSent      Int      @default(0)
  emailsDelivered Int      @default(0)
  emailsBounced   Int      @default(0)
  emailsOpened    Int      @default(0)
  emailsClicked   Int      @default(0)
  emailsReplied   Int      @default(0)
  
  // SMS metrics
  smsSent         Int      @default(0)
  smsDelivered    Int      @default(0)
  smsReplied      Int      @default(0)
  
  // Voicemail metrics
  voicemailsSent  Int      @default(0)
  voicemailsDelivered Int   @default(0)
  
  // LinkedIn metrics
  linkedinSent    Int      @default(0)
  linkedinAccepted Int     @default(0)
  linkedinReplied Int      @default(0)
  
  // Conversion metrics
  qualified       Int      @default(0)
  demosBooked     Int      @default(0)
  auditsRequested Int      @default(0)
  dealsCreated    Int      @default(0)
  
  // Engagement metrics
  avgLeadScore    Float?
  avgEngagementRate Float?
  
  createdAt       DateTime @default(now())
  
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  @@unique([campaignId, date])
  @@index([campaignId])
  @@index([date])
}

// Interactive Audit Tool - Lead qualification tool
model AuditRequest {
  id                  String   @id @default(cuid())
  
  // Contact info
  email               String
  name                String?
  firstName           String?
  lastName            String?
  company             String?
  title               String?
  phone               String?
  
  // Link to CRM
  personId            String?
  person              Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)
  organizationId      String?
  organization        Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  // Audit questions
  propertyType        String?  // office, apartment, hospitality, mixed-use
  propertySize        String?  // square footage or units
  numberOfUnits       Int?
  independentSystems  Int?     // How many separate systems
  physicalNetworks    Int?     // How many networks
  currentVendors      String?  @db.Text // List of current vendors
  painPoints          String?  @db.Text // Described pain points
  
  // Additional qualification
  decisionMaker       Boolean  @default(false)
  budget              String?  // budget range
  timeline            String?  // implementation timeline
  
  // Lead scoring
  score               Int?     @default(0) // 0-100
  qualification       String?  @default("new") // new, qualified, not-qualified, contacted
  
  // Booking
  bookingUrl          String?  // Calendly link
  bookingCompleted    Boolean  @default(false)
  bookedAt            DateTime?
  meetingScheduledFor DateTime?
  
  // Conversion
  convertedToDealId   String?
  convertedToDeal     Deal?    @relation(fields: [convertedToDealId], references: [id], onDelete: SetNull)
  convertedAt         DateTime?
  
  // Source tracking
  source              String?  // website, campaign, conference
  campaignId          String?
  utmSource           String?
  utmMedium           String?
  utmCampaign         String?
  
  // Status
  status              String   @default("pending") // pending, contacted, qualified, converted, lost
  
  // Follow-up
  contactedAt         DateTime?
  contactedBy         String?
  notes               String?  @db.Text
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([email])
  @@index([personId])
  @@index([organizationId])
  @@index([status])
  @@index([score])
  @@index([convertedToDealId])
  @@index([createdAt])
}

// Book Distribution - Track book requests and engagement
model BookRequest {
  id              String   @id @default(cuid())
  
  // Contact info
  email           String
  name            String
  firstName       String?
  lastName        String?
  company         String?
  title           String?
  phone           String?
  
  // Link to CRM
  personId        String?
  person          Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  // Request details
  type            String   // digital, physical, both
  format          String?  // pdf, epub, kindle (for digital)
  
  // Shipping (for physical)
  shippingAddress String?  @db.Text
  shippingCity    String?
  shippingState   String?
  shippingZip     String?
  shippingCountry String?
  
  // Fulfillment
  status          String   @default("pending") // pending, processing, shipped, delivered, downloaded
  downloadedAt    DateTime?
  downloadCount   Int      @default(0)
  shippedAt       DateTime?
  trackingNumber  String?
  deliveredAt     DateTime?
  
  // Engagement tracking
  lastAccessedAt  DateTime?
  chaptersRead    Json?    // Array of chapter numbers/names read
  timeSpentReading Int?    // Minutes
  
  // Source tracking
  source          String?  // website, campaign, conference, manual
  campaignId      String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  
  // Conversion
  convertedToDealId String?
  convertedToDeal   Deal?  @relation(fields: [convertedToDealId], references: [id], onDelete: SetNull)
  convertedAt       DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  engagements     BookEngagement[]
  
  @@index([email])
  @@index([personId])
  @@index([organizationId])
  @@index([status])
  @@index([convertedToDealId])
  @@index([createdAt])
}

// Book Engagement - Track reading activity
model BookEngagement {
  id              String   @id @default(cuid())
  requestId       String
  
  // Engagement details
  chapter         String?  // Chapter number or name
  page            Int?
  action          String   // opened, read, clicked_link, downloaded
  linkClicked     String?  // URL if clicked
  
  // Metadata
  deviceType      String?  // desktop, mobile, tablet
  location        String?  // IP-based location
  
  timestamp       DateTime @default(now())
  
  request         BookRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  @@index([requestId])
  @@index([timestamp])
}

// Conference Campaigns - Event-based marketing
model Conference {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  
  // Event details
  location    String?
  venue       String?
  startDate   DateTime
  endDate     DateTime
  
  // Website and registration
  websiteUrl  String?
  registrationUrl String?
  
  // Booth/presence info
  boothNumber String?
  teamMembers Json?    // Array of team member names/emails
  
  // Goals
  targetMeetings Int?
  targetLeads    Int?
  booksToDistribute Int?
  
  // Status
  status      String   @default("upcoming") // upcoming, active, completed, cancelled
  
  // Campaign links
  preCampaignId  String?
  postCampaignId String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  attendees   ConferenceAttendee[]
  
  @@index([startDate])
  @@index([status])
}

// Conference Attendees - People at events
model ConferenceAttendee {
  id            String   @id @default(cuid())
  conferenceId  String
  
  // Contact info
  email         String
  name          String?
  firstName     String?
  lastName      String?
  company       String?
  title         String?
  phone         String?
  linkedInUrl   String?
  
  // Link to CRM
  personId      String?
  person        Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)
  organizationId String?
  organization  Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  // Event interaction
  metAtEvent    Boolean  @default(false)
  metBy         String?  // Team member who met them
  metAt         DateTime?
  boothVisit    Boolean  @default(false)
  
  // Book distribution
  bookReceived  Boolean  @default(false)
  bookReceivedAt DateTime?
  
  // Meeting scheduling
  meetingBooked Boolean  @default(false)
  meetingBookedAt DateTime?
  meetingScheduledFor DateTime?
  
  // Follow-up
  followedUp    Boolean  @default(false)
  followedUpAt  DateTime?
  
  // Conversion
  convertedToDealId String?
  convertedToDeal   Deal?  @relation(fields: [convertedToDealId], references: [id], onDelete: SetNull)
  convertedAt       DateTime?
  
  // Source
  source        String?  // attendee-list, booth-visit, networking, manual
  importedFrom  String?  // CSV filename or source
  
  // Lead score
  score         Int      @default(0)
  qualification String?  // hot, warm, cold, not-qualified
  
  notes         String?  @db.Text
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  conference    Conference @relation(fields: [conferenceId], references: [id], onDelete: Cascade)
  
  @@index([conferenceId])
  @@index([email])
  @@index([personId])
  @@index([organizationId])
  @@index([metAtEvent])
  @@index([convertedToDealId])
}

// Email Templates - Reusable email templates
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  
  // Template content
  subject     String
  bodyText    String   @db.Text  // Plain text version
  bodyHtml    String   @db.Text  // HTML version
  
  // Variables/placeholders
  variables   Json?    // Array of variable names: ['firstName', 'company', etc.]
  
  // Category
  category    String?  // welcome, follow-up, nurture, conference, book-offer
  
  // Status
  isActive    Boolean  @default(true)
  
  // Usage tracking
  timesUsed   Int      @default(0)
  lastUsedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([isActive])
}

// Chatbot Conversations - External website chatbot
model ChatbotConversation {
  id              String   @id @default(cuid())
  
  // Visitor info
  visitorId       String   // Anonymous ID or email
  email           String?
  name            String?
  company         String?
  
  // Link to CRM
  personId        String?
  person          Person?  @relation(fields: [personId], references: [id], onDelete: SetNull)
  
  // Conversation status
  status          String   @default("active") // active, qualified, converted, abandoned
  
  // Qualification
  isQualified     Boolean  @default(false)
  qualifiedAt     DateTime?
  leadScore       Int      @default(0)
  
  // Conversion
  goalAchieved    String?  // audit-requested, meeting-booked, demo-scheduled
  convertedAt     DateTime?
  convertedToDealId String?
  convertedToDeal   Deal?  @relation(fields: [convertedToDealId], references: [id], onDelete: SetNull)
  
  // Source tracking
  pageUrl         String?
  referrer        String?
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  
  // Session info
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  duration        Int?     // Seconds
  
  // Metadata
  ipAddress       String?
  userAgent       String?
  location        String?  // IP-based location
  
  updatedAt       DateTime @updatedAt
  
  messages        ChatbotMessage[]
  
  @@index([visitorId])
  @@index([email])
  @@index([personId])
  @@index([status])
  @@index([convertedToDealId])
  @@index([startedAt])
}

// Chatbot Messages - Individual messages in conversations
model ChatbotMessage {
  id              String   @id @default(cuid())
  conversationId  String
  
  // Message details
  role            String   // user, assistant, system
  content         String   @db.Text
  
  // Intent detection
  intent          String?  // greeting, question, qualification, booking
  confidence      Float?
  
  // Extracted data
  extractedData   Json?    // Structured data extracted from message
  
  timestamp       DateTime @default(now())
  
  conversation    ChatbotConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([timestamp])
}


