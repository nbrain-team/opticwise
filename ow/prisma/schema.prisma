generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deals        Deal[]   @relation("DealOwner")
}

model Pipeline {
  id        String  @id @default(cuid())
  name      String  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stages    Stage[]
  deals     Deal[]
}

model Stage {
  id         String   @id @default(cuid())
  name       String
  orderIndex Int
  pipelineId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  deals    Deal[]

  @@unique([pipelineId, name])
  @@unique([pipelineId, orderIndex])
}

model Organization {
  id           String   @id @default(cuid())
  name         String   @unique
  address      String?  // Legacy full address
  websiteUrl   String?
  domain       String?
  linkedInProfile String?
  industry     String?
  annualRevenue String?
  numberOfEmployees String?
  doors        String?
  labels       String?
  profilePicture String?
  
  // Detailed address fields
  streetAddress String?  // Street/road name
  houseNumber  String?   // House number
  apartmentSuite String? // Apartment/suite no
  district     String?   // District/sublocality
  city         String?   // City/town/village/locality
  state        String?   // State/county
  region       String?   // Region
  country      String?   // Country
  zipCode      String?   // ZIP/Postal code
  fullAddress  String?   // Full/combined address
  latitude     String?
  longitude    String?
  
  // Activity tracking from Pipedrive
  openDeals      Int?
  wonDeals       Int?
  lostDeals      Int?
  closedDeals    Int?
  totalActivities Int?
  doneActivities Int?
  activitiesToDo Int?
  emailMessagesCount Int?
  nextActivityDate DateTime?
  lastActivityDate DateTime?
  
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  people Person[]
  deals  Deal[]
  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
  gmailMessages GmailMessage[]
  calendarEvents CalendarEvent[]
  driveFiles DriveFile[]
  noteRecords Note[]
  activities Activity[]
}

model Person {
  id             String   @id @default(cuid())
  name           String?  // Full name for easy display
  firstName      String
  lastName       String
  email          String?  @unique
  phone          String?  // Keep for backward compat
  phoneWork      String?
  phoneHome      String?
  phoneMobile    String?
  phoneOther     String?
  emailWork      String?
  emailHome      String?
  emailOther     String?
  title          String?  // Job title
  labels         String?
  contactType    String?
  organizationId String?
  
  // Address fields
  postalAddress  String?  // Full combined address
  streetAddress  String?  // Street/road name
  houseNumber    String?  // House number
  apartmentSuite String?  // Apartment/suite no
  city           String?  // City/town/village/locality
  state          String?  // State/county
  region         String?  // Region
  country        String?  // Country
  zipCode        String?  // ZIP/Postal code
  latitude       String?
  longitude      String?
  
  // Personal info
  birthday       DateTime?
  notes          String?
  linkedInProfile String?
  qwilrProposal  String?
  classification String?
  instantMessenger String?
  marketingStatus String?
  doubleOptIn    String?
  profilePicture String?
  
  // Activity tracking from Pipedrive
  openDeals      Int?
  wonDeals       Int?
  lostDeals      Int?
  closedDeals    Int?
  totalActivities Int?
  doneActivities Int?
  activitiesToDo Int?
  emailMessagesCount Int?
  nextActivityDate DateTime?
  lastActivityDate DateTime?
  lastEmailReceived DateTime?
  lastEmailSent  DateTime?
  
  customFields   Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  deals        Deal[]
  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
  gmailMessages GmailMessage[]
  calendarEvents CalendarEvent[]
  driveFiles DriveFile[]
  noteRecords Note[]
  activities Activity[]
}

enum DealStatus {
  open
  won
  lost
  deleted
}

model Deal {
  id                String      @id @default(cuid())
  title             String
  value             Decimal     @default(0)
  currency          String      @default("USD")
  status            DealStatus  @default(open)
  probability       Int?
  expectedCloseDate DateTime?
  wonTime           DateTime?
  lostTime          DateTime?
  lostReason        String?
  label             String?
  labels            String?
  
  // Activity tracking
  nextActivityDate  DateTime?
  lastActivityDate  DateTime?
  totalActivities   Int?
  doneActivities    Int?
  activitiesToDo    Int?
  
  // Email tracking
  lastEmailReceived DateTime?
  lastEmailSent     DateTime?
  emailMessagesCount Int?
  
  // Products
  productQuantity   String?
  productAmount     Decimal?
  productName       String?
  mrr               Decimal?
  mrrCurrency       String?
  arr               Decimal?
  arrCurrency       String?
  acv               Decimal?
  acvCurrency       String?
  
  // Source tracking
  sourceOrigin      String?
  sourceOriginId    String?
  sourceChannel     String?
  sourceChannelId   String?
  
  // Custom Opticwise fields
  goLiveTarget      String?
  propertyAddress   String?
  propertyType      String?
  qty               String?  // units, beds, sqft
  arrForecast       Decimal?
  arrForecastCurrency String?
  capexRom          Decimal?
  capexRomCurrency  String?
  roiNoiBomSheet    String?
  printsPlansExternal String?
  printsPlansDropbox String?
  leadSource        String?
  technicalPOC      String?
  icpSegment        String?
  leadSourcePPP     String?
  readinessScore    String?
  ddiAuditStatus    String?
  auditValue        Decimal?
  auditValueCurrency String?
  arrExpansionPotential Decimal?
  arrExpansionCurrency String?
  
  addTime           DateTime    @default(now())
  updateTime        DateTime    @updatedAt
  stageChangeTime   DateTime    @default(now()) // When deal entered current stage
  position          Int         @default(0) // ordering within a stage
  customFields      Json?       // For any additional dynamic fields

  pipelineId     String
  stageId        String
  organizationId String?
  personId       String?
  ownerId        String

  pipeline     Pipeline     @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stage        Stage        @relation(fields: [stageId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  owner        User          @relation("DealOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
  gmailMessages GmailMessage[]
  calendarEvents CalendarEvent[]
  driveFiles DriveFile[]
  noteRecords Note[]
  activities Activity[]

  @@index([pipelineId, stageId])
  @@index([ownerId])
  @@index([organizationId])
  @@index([personId])
}

enum EmailDirection {
  INCOMING
  OUTGOING
}

model EmailThread {
  id             String         @id @default(cuid())
  subject        String
  dealId         String?
  personId       String?
  organizationId String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  messages     EmailMessage[]
}

model EmailMessage {
  id        String         @id @default(cuid())
  threadId  String
  sender    String
  recipients String
  cc        String?
  bcc       String?
  body      String
  direction EmailDirection
  sentAt    DateTime
  createdAt DateTime       @default(now())

  thread EmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

// Fathom.ai Call Transcripts
model CallTranscript {
  id                String   @id @default(cuid())
  fathomCallId      String   @unique  // External ID from Fathom
  title             String
  transcript        String   @db.Text  // Full transcript text
  transcriptJson    Json?    // Structured transcript with speakers and timestamps
  summary           String?  @db.Text  // AI-generated summary if provided by Fathom
  
  // Call metadata
  startTime         DateTime
  endTime           DateTime?
  duration          Int?     // Duration in seconds
  recordingUrl      String?
  
  // Participants (stored as JSON array)
  participants      Json?    // [{name: string, email?: string}]
  
  // Linking to CRM entities
  dealId            String?
  personId          String?
  organizationId    String?
  
  // Metadata
  metadata          Json?    // Raw data from Fathom
  vectorized        Boolean  @default(false) // Flag for AI vectorization status
  vectorEmbedding   String?  @db.Text // Embedding for semantic search (if using)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([fathomCallId])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([startTime])
}

// Google Workspace Integration Models

model GmailMessage {
  id              String   @id @default(cuid())
  gmailMessageId  String   @unique  // Google's message ID
  threadId        String
  subject         String?
  snippet         String?  // Short preview
  body            String?  @db.Text  // Full email body
  bodyHtml        String?  @db.Text  // HTML version
  
  // Participants
  from            String
  to              String?  @db.Text  // Can be multiple, comma-separated
  cc              String?  @db.Text
  bcc             String?  @db.Text
  
  // Metadata
  date            DateTime
  labels          String?  // JSON array of labels
  attachments     Json?    // Array of attachment metadata
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text  // JSON array of embedding vector
  
  // Linking to CRM
  dealId          String?
  personId        String?
  organizationId  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([gmailMessageId])
  @@index([threadId])
  @@index([date])
  @@index([from])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([vectorized])
}

model CalendarEvent {
  id              String   @id @default(cuid())
  googleEventId   String   @unique  // Google's event ID
  summary         String
  description     String?  @db.Text
  location        String?
  
  // Time
  startTime       DateTime
  endTime         DateTime
  timezone        String?
  allDay          Boolean  @default(false)
  
  // Participants
  organizer       String?
  attendees       Json?    // Array of {email, name, responseStatus}
  
  // Meeting details
  meetingLink     String?  // Google Meet or other video link
  conferenceData  Json?    // Full conference details
  
  // Status
  status          String?  // confirmed, tentative, cancelled
  visibility      String?  // default, public, private
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text
  
  // Linking to CRM
  dealId          String?
  personId        String?
  organizationId  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([googleEventId])
  @@index([startTime])
  @@index([organizer])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([vectorized])
}

model DriveFile {
  id              String   @id @default(cuid())
  googleFileId    String   @unique  // Google's file ID
  name            String
  mimeType        String
  description     String?  @db.Text
  
  // File metadata
  size            BigInt?
  webViewLink     String?
  thumbnailLink   String?
  iconLink        String?
  
  // Content for search
  content         String?  @db.Text  // Extracted text content for documents
  
  // Timestamps
  createdTime     DateTime?
  modifiedTime    DateTime?
  viewedTime      DateTime?
  
  // Ownership
  ownedByMe       Boolean  @default(false)
  owners          Json?    // Array of owner info
  sharedWith      Json?    // Array of people with access
  
  // Organization
  parents         Json?    // Array of parent folder IDs
  folderPath      String?  // Computed folder path
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text
  
  // Linking to CRM
  dealId          String?
  personId        String?
  organizationId  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([googleFileId])
  @@index([mimeType])
  @@index([createdTime])
  @@index([modifiedTime])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([vectorized])
}

// Notes - Manual notes added to deals, people, organizations
model Note {
  id              String   @id @default(cuid())
  content         String   @db.Text
  
  // Linking to CRM entities
  dealId          String?
  personId        String?
  organizationId  String?
  
  // Author tracking
  createdBy       String?  // User email or name
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([createdAt])
}

// Activities - To-dos and tasks
enum ActivityType {
  call
  meeting
  task
  deadline
  email
  lunch
}

enum ActivityStatus {
  pending
  done
  cancelled
}

model Activity {
  id              String         @id @default(cuid())
  subject         String
  note            String?        @db.Text
  type            ActivityType   @default(task)
  status          ActivityStatus @default(pending)
  
  // Scheduling
  dueDate         DateTime?
  dueTime         String?        // Time in HH:MM format
  duration        Int?           // Duration in minutes
  
  // Linking to CRM entities
  dealId          String?
  personId        String?
  organizationId  String?
  
  // Assignment
  assignedTo      String?        // User email or name
  createdBy       String?        // User email or name
  
  // Completion tracking
  doneTime        DateTime?
  markedAsDoneBy  String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([status])
  @@index([dueDate])
  @@index([createdAt])
}

// Website Pages - Scraped and vectorized web pages from sitemap
model WebPage {
  id              String   @id @default(cuid())
  url             String   @unique  // Full URL of the page
  slug            String?           // Path/slug portion of URL
  title           String?           // Page title from <title> tag
  metaDescription String?  @db.Text  // Meta description
  
  // Content
  content         String?  @db.Text  // Extracted text content from page
  headings        Json?              // Array of headings [{level, text}]
  
  // Metadata
  lastModified    DateTime?          // From sitemap lastmod
  changeFreq      String?            // From sitemap changefreq
  
  // Vectorization for AI search
  vectorized      Boolean  @default(false)
  embedding       String?  @db.Text  // JSON array of embedding vector
  
  // Scraping metadata
  scrapedAt       DateTime?
  scrapeStatus    String?  @default("pending")  // pending, success, failed
  scrapeError     String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([url])
  @@index([vectorized])
  @@index([scrapeStatus])
  @@index([scrapedAt])
}


