generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deals        Deal[]   @relation("DealOwner")
}

model Pipeline {
  id        String  @id @default(cuid())
  name      String  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stages    Stage[]
  deals     Deal[]
}

model Stage {
  id         String   @id @default(cuid())
  name       String
  orderIndex Int
  pipelineId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  deals    Deal[]

  @@unique([pipelineId, name])
  @@unique([pipelineId, orderIndex])
}

model Organization {
  id           String   @id @default(cuid())
  name         String   @unique
  address      String?
  websiteUrl   String?
  domain       String?
  linkedInProfile String?
  industry     String?
  annualRevenue String?
  numberOfEmployees String?
  doors        String?
  labels       String?
  profilePicture String?
  latitude     String?
  longitude    String?
  customFields Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  people Person[]
  deals  Deal[]
  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
}

model Person {
  id             String   @id @default(cuid())
  name           String?  // Full name for easy display
  firstName      String
  lastName       String
  email          String?  @unique
  phone          String?  // Keep for backward compat
  phoneWork      String?
  phoneHome      String?
  phoneMobile    String?
  phoneOther     String?
  emailWork      String?
  emailHome      String?
  emailOther     String?
  title          String?  // Job title
  labels         String?
  contactType    String?
  organizationId String?
  postalAddress  String?
  birthday       DateTime?
  notes          String?
  linkedInProfile String?
  qwilrProposal  String?
  classification String?
  instantMessenger String?
  marketingStatus String?
  doubleOptIn    String?
  profilePicture String?
  latitude       String?
  longitude      String?
  customFields   Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  deals        Deal[]
  emailThreads EmailThread[]
  callTranscripts CallTranscript[]
}

enum DealStatus {
  open
  won
  lost
  deleted
}

model Deal {
  id                String      @id @default(cuid())
  title             String
  value             Decimal     @default(0)
  currency          String      @default("USD")
  status            DealStatus  @default(open)
  probability       Int?
  expectedCloseDate DateTime?
  wonTime           DateTime?
  lostTime          DateTime?
  lostReason        String?
  label             String?
  labels            String?
  
  // Activity tracking
  nextActivityDate  DateTime?
  lastActivityDate  DateTime?
  totalActivities   Int?
  doneActivities    Int?
  activitiesToDo    Int?
  
  // Email tracking
  lastEmailReceived DateTime?
  lastEmailSent     DateTime?
  emailMessagesCount Int?
  
  // Products
  productQuantity   String?
  productAmount     Decimal?
  productName       String?
  mrr               Decimal?
  mrrCurrency       String?
  arr               Decimal?
  arrCurrency       String?
  acv               Decimal?
  acvCurrency       String?
  
  // Source tracking
  sourceOrigin      String?
  sourceOriginId    String?
  sourceChannel     String?
  sourceChannelId   String?
  
  // Custom Opticwise fields
  goLiveTarget      String?
  propertyAddress   String?
  propertyType      String?
  qty               String?  // units, beds, sqft
  arrForecast       Decimal?
  arrForecastCurrency String?
  capexRom          Decimal?
  capexRomCurrency  String?
  roiNoiBomSheet    String?
  printsPlansExternal String?
  printsPlansDropbox String?
  leadSource        String?
  technicalPOC      String?
  icpSegment        String?
  leadSourcePPP     String?
  readinessScore    String?
  ddiAuditStatus    String?
  auditValue        Decimal?
  auditValueCurrency String?
  arrExpansionPotential Decimal?
  arrExpansionCurrency String?
  
  addTime           DateTime    @default(now())
  updateTime        DateTime    @updatedAt
  position          Int         @default(0) // ordering within a stage
  customFields      Json?       // For any additional dynamic fields

  pipelineId     String
  stageId        String
  organizationId String?
  personId       String?
  ownerId        String

  pipeline     Pipeline     @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  stage        Stage        @relation(fields: [stageId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  owner        User          @relation("DealOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  emailThreads EmailThread[]
  callTranscripts CallTranscript[]

  @@index([pipelineId, stageId])
  @@index([ownerId])
  @@index([organizationId])
  @@index([personId])
}

enum EmailDirection {
  INCOMING
  OUTGOING
}

model EmailThread {
  id             String         @id @default(cuid())
  subject        String
  dealId         String?
  personId       String?
  organizationId String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  messages     EmailMessage[]
}

model EmailMessage {
  id        String         @id @default(cuid())
  threadId  String
  sender    String
  recipients String
  cc        String?
  bcc       String?
  body      String
  direction EmailDirection
  sentAt    DateTime
  createdAt DateTime       @default(now())

  thread EmailThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

// Fathom.ai Call Transcripts
model CallTranscript {
  id                String   @id @default(cuid())
  fathomCallId      String   @unique  // External ID from Fathom
  title             String
  transcript        String   @db.Text  // Full transcript text
  transcriptJson    Json?    // Structured transcript with speakers and timestamps
  summary           String?  @db.Text  // AI-generated summary if provided by Fathom
  
  // Call metadata
  startTime         DateTime
  endTime           DateTime?
  duration          Int?     // Duration in seconds
  recordingUrl      String?
  
  // Participants (stored as JSON array)
  participants      Json?    // [{name: string, email?: string}]
  
  // Linking to CRM entities
  dealId            String?
  personId          String?
  organizationId    String?
  
  // Metadata
  metadata          Json?    // Raw data from Fathom
  vectorized        Boolean  @default(false) // Flag for AI vectorization status
  vectorEmbedding   String?  @db.Text // Embedding for semantic search (if using)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  deal         Deal?         @relation(fields: [dealId], references: [id], onDelete: SetNull)
  person       Person?       @relation(fields: [personId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  
  @@index([fathomCallId])
  @@index([dealId])
  @@index([personId])
  @@index([organizationId])
  @@index([startTime])
}


